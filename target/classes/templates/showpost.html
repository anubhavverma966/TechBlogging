<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    
	
    <title th:text="${showpost.pTitle}"></title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        body {
            background: url('/image/blog.jpg');
            background-size: cover;
            background-attachment: fixed;
        }
        .post-title {
            font-weight: 100;
            font-size: 30px;
        }
        .post-content {
            font-weight: 100;
            font-size: 24px;
        }
        .post-date {
            font-style: italic;
            font-weight: bold;
        }
        .post-user-info {
            font-size: 20px;
        }
        .highlight-nav {
		    background-color: white;
		    color: #7e57c2 !important;
		    border-radius: 20px;
		    padding: 6px 14px;
		    font-weight: 600;
		    display: inline-block;
    		width: auto;
		}
		
		.highlight-nav:hover {
		    background-color: #f2eaff;
		}
        .row-user {
            border: 1px solid #7e57c2;
            padding-top: 15px;
        }
        .primary-color {
            background-color: #7e57c2 !important;
        }
        .banner-background {
            background-color: #7e57c2;
            clip-path: polygon(0 0, 100% 0, 100% 97%, 67% 100%, 33% 98%, 0 100%);
        }
        .c-link.active {
            color: white;
        }
        .modal-header.primary-color {
            background-color: #7e57c2 !important;
        }
        .img-profile {
            border-radius: 50%;
            max-width: 150px;
        }
    </style>
</head>
<body>

<!-- ✅ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark primary-color">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">
            <span class="fa fa-wpforms"></span> TechBlogging
        </a>

        <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav d-flex flex-column flex-lg-row gap-2 me-auto mb-2 mb-lg-0">

                <li class="nav-item">
                    <a class="nav-link active" style="color: white;" th:href="@{/profilePage}">
                        <span class="fa fa-paste"></span> Blog Page
                    </a>
                </li>

                
                <li class="nav-item">
                    <a class="nav-link active" href="#"><span class="fa fa-address-book-o"></span> Contact Us</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active highlight-nav" href="#" data-bs-toggle="modal" data-bs-target="#addModal">
                        <span class="fa fa-paper-plane-o"></span> Add Posts
                    </a>
                </li>
                
                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <a class="nav-link active highlight-nav" href="#" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        <span class="fa fa-cogs"></span> Add Categories
                    </a>
                </li>
            </ul>

            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                        <span class="fa fa-user-circle"></span>
                        <span th:text="${currentUser.name}"></span>
                    </a>
                </li>
                <li class="nav-item">
				    <a class="nav-link active" href="#" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
				        <span class="fa fa-sign-out"></span> Logout
				    </a>
				</li>
            </ul>
        </div>
    </div>
</nav>

<form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
</form>

<!-- ✅ Main Post Section -->
<div class="container my-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header primary-color text-white d-flex justify-content-between align-items-center">
                    <h4 class="post-title mb-0" th:text="${showpost.pTitle}"></h4>
                    <div class="d-flex gap-2">
                    	<!-- Edit button -->                
						<a href="#"
						   class="btn btn-outline-light btn-sm edit-post-btn"
						   th:attr="data-id=${showpost.pid}"
						   onclick="openEditModal(this.dataset.id)">
						    <i class="fa fa-pencil"></i>
						</a>
		                
		                <!-- Delete -->
						<a href="#!"
						   sec:authorize="hasRole('ADMIN')"
						   class="btn btn-outline-light btn-sm"
						   th:onclick="|deletePost(${showpost.pid})|">
						    <i class="fa fa-trash"></i>
						</a>
                    </div>
                </div>

                <div class="card-body">
                    <img class="card-img-top my-2"
                         th:src="@{'/blog_pics/' + ${showpost.pPic}}"
                         alt="Blog Image">

                    <div class="row my-3 row-user">
                        <div class="col-md-8">
                            <p class="post-user-info">
                                <a href="#!" th:text="${showpost.user.name}"></a> has posted this Blog
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <p class="post-date"
                               th:text="${#dates.format(showpost.pDate, 'dd-MMM-yyyy hh:mm:ss a')}"></p>
                        </div>
                    </div>

                    <p class="post-content" th:text="${showpost.pContent}"></p>

                    <div class="post-code">
                        <pre th:text="${showpost.pCode}"></pre>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ✅ Modals -->
<div th:replace="~{fragments/profileModal :: profileModal}"></div>
<div th:replace="~{fragments/addPostModal :: addPostModal}"></div>
<div th:replace="~{fragments/addCategoryModal :: addCategoryModal}"></div>
<div th:replace="~{fragments/updatePostModal :: updatePostModal}"></div>

<!-- ✅ Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
	
	
	document.addEventListener("submit", async function (event) {
	    const form = event.target.closest("#add-post-form");
	    if (!form) return;
	    event.preventDefault();
	
	    console.log("Submitting post...");
	    const formData = new FormData(form);
	
	    try {
	        const response = await fetch("/addPost", {
	            method: "POST",
	            body: formData
	        });
	
	        const data = await response.text();
	        console.log("Response:", data);
	
	        if (data.trim() === "done") {
        	  Swal.fire({
        	    icon: "success",
        	    title: "Good Job!",
        	    text: "Saved successfully.",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	} else if (data.trim() === "Unauthorized") {
        	  Swal.fire({
        	    icon: "warning",
        	    title: "Unauthorized",
        	    text: "Please login first.",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	} else if (data.trim() === "file-error") {
        	  Swal.fire({
        	    icon: "error",
        	    title: "Error",
        	    text: "Failed to save image file.",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	} else {
        	  Swal.fire({
        	    icon: "error",
        	    title: "Error",
        	    text: "Something went wrong! Try again...",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	}

	
	    } catch (error) {
	        console.error("Error:", error);
	        Swal.fire({
        	    icon: "error",
        	    title: "Error",
        	    text: "Something went wrong! Try again...",
        	    timer: 1500
        	});
	        window.location.reload();
	    }
	});

</script>
	

<script>
	
		
	document.addEventListener("submit", async function (event) {
	    const form = event.target.closest("#add-categry-form");
	    if (!form) return;
	    event.preventDefault();
	
	    console.log("Saving category...");
	    const formData = new FormData(form);
	
	    try {
	        const response = await fetch("/addCategory", {
	            method: "POST",
	            body: formData
	        });
	
	        const data = await response.text();
	        console.log("Response:", data);
	
	        if (data.trim() === "done") {
        	  Swal.fire({
        	    icon: "success",
        	    title: "Good Job!",
        	    text: "Category saved successfully.",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	} else if (data.trim() === "Unauthorized") {
        	  Swal.fire({
        	    icon: "warning",
        	    title: "Unauthorized",
        	    text: "Please login first.",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	} else if (data.trim() === "file-error") {
        	  Swal.fire({
        	    icon: "error",
        	    title: "Error",
        	    text: "Failed to save image file.",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	} else {
        	  Swal.fire({
        	    icon: "error",
        	    title: "Error",
        	    text: "Something went wrong! Try again...",
        	    timer: 1500
        	  });
        	  window.location.reload();
        	}

	
	    } catch (error) {
	        console.error("Error:", error);
	        Swal.fire({
        	    icon: "error",
        	    title: "Error",
        	    text: "Something went wrong! Try again...",
        	    timer: 1500
        	});
	        window.location.reload();
	    }
	});

</script>

<script>
	document.addEventListener("click", function (event) {
	    const editBtn = event.target.closest("#edit-profile-button");
	    if (!editBtn) return;
	
	    const profileDetails = document.getElementById("profile-details");
	    const profileEdit = document.getElementById("profile-edit");
	
	    if (profileDetails && profileEdit) {
	        const isEditing = profileEdit.style.display === "block";
	
	        if (isEditing) {
	            profileDetails.style.display = "block";
	            profileEdit.style.display = "none";
	            editBtn.textContent = "EDIT";
	        } else {
	            profileDetails.style.display = "none";
	            profileEdit.style.display = "block";
	            editBtn.textContent = "Back";
	        }
	    }
	});
</script>


<script th:inline="javascript">
  const appContextPath = /*[[@{/}]]*/ '';  // "" or "/Techblogging"

  async function openEditModal(id) {
    try {
      const resp = await fetch(`${appContextPath}post/${id}`);
      if (!resp.ok) throw new Error('Failed to fetch post');
      const data = await resp.json();

      // populate fields
      document.getElementById('edit-post-id').value    = data.id ?? '';
      document.getElementById('edit-post-title').value = data.title ?? '';
      document.getElementById('edit-post-content').value = data.content ?? '';
      document.getElementById('edit-post-code').value = data.code ?? '';

      // category select etc...

      // image preview
      const preview = document.getElementById('edit-post-preview');
      if (preview) {
        if (data.pic) {
          preview.src = appContextPath + 'blog_pics/' + encodeURIComponent(data.pic);
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      }

      const editModalEl = document.getElementById('updatePostModal');
      const modal = bootstrap.Modal.getOrCreateInstance(editModalEl);
      modal.show();

    } catch (err) {
      console.error('openEditModal error:', err);
      alert('Could not load post for editing.');
    }
  }
</script>

<script>
	async function deletePost(id) {
	
	    const result = await Swal.fire({
	        title: "Are you sure?",
	        text: "This post will be permanently deleted!",
	        icon: "warning",
	        showCancelButton: true,
	        confirmButtonColor: "#d33",
	        cancelButtonColor: "#3085d6",
	        confirmButtonText: "Yes, delete it!"
	    });
	
	    if (!result.isConfirmed) return;
	
	    try {
	        const resp = await fetch(`/deletePost/${id}`, {
	            method: "DELETE"
	        });
	
	        const msg = await resp.text();
	
	        if (resp.ok && msg.includes("Deleted")) {
	            await Swal.fire({
	                icon: "success",
	                title: "Deleted!",
	                text: msg,
	                timer: 1500,
	                showConfirmButton: false
	            });
	            window.location.href = '/profilePage';
	        } else {
	            Swal.fire({
	                icon: "error",
	                title: "Action Denied",
	                text: msg
	            });
	        }
	
	    } catch (err) {
	        console.error("Delete error:", err);
	        Swal.fire({
	            icon: "error",
	            title: "Network Error",
	            text: "Could not delete post. Please try again."
	        });
	    }
	}
</script>

</body>
</html>
