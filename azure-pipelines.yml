<<<<<<< HEAD
# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

=======
>>>>>>> ea5575b (ci: containerization and ACA deployment readiness)
trigger:
  branches:
    include:
      - master

<<<<<<< HEAD
pool:
  vmImage: ubuntu-latest

variables:
  JAVA_VERSION: '21'
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2
  APP_NAME: techblog-app-prod
  RESOURCE_GROUP: techblog-rg
  SERVICE_CONNECTION: azure.techblog-conn

steps:

# 1️⃣ Checkout code
- checkout: self
  clean: true

# 2️⃣ Cache Maven dependencies
- task: Cache@2
  inputs:
    key: 'maven | "$(Agent.OS)" | **/pom.xml'
    restoreKeys: |
      maven | "$(Agent.OS)"
    path: $(MAVEN_CACHE_FOLDER)

# 3️⃣ Set up Java 17
- task: JavaToolInstaller@0
  inputs:
    versionSpec: $(JAVA_VERSION)
    jdkArchitectureOption: x64
    jdkSourceOption: PreInstalled

# 4️⃣ Build Spring Boot app
- task: Maven@4
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.$(JAVA_VERSION)'
    mavenOptions: '-Xmx1024m'
    publishJUnitResults: false

# 5️⃣ Deploy to Azure App Service (Linux)
- task: AzureWebApp@1
  inputs:
    azureSubscription: $(SERVICE_CONNECTION)
    appType: webAppLinux
    appName: $(APP_NAME)
    resourceGroupName: $(RESOURCE_GROUP)
    package: '$(System.DefaultWorkingDirectory)/target/*.jar'
=======
variables:
  ACR_NAME: techblogacr
  IMAGE_NAME: techblog
  RESOURCE_GROUP: rg-techblog-prod
  CONTAINER_APP: techblog-app

stages:
- stage: BuildAndDeploy
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: Docker@2
      displayName: Build & Push Image
      inputs:
        containerRegistry: azure-techblog-conn
        repository: $(IMAGE_NAME)
        command: buildAndPush
        Dockerfile: Dockerfile
        tags: |
          $(Build.BuildId)

    - task: AzureCLI@2
      displayName: Deploy to Container App
      inputs:
        azureSubscription: azure-techblog-conn
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az containerapp update \
            --name $(CONTAINER_APP) \
            --resource-group $(RESOURCE_GROUP) \
            --image $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)
>>>>>>> ea5575b (ci: containerization and ACA deployment readiness)
