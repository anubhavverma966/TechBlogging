<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
		
	<title>Profile - TechBlogging</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        .primary-color {
            background-color: #7e57c2 !important;
        }
        .banner-background {
            background-color: #7e57c2;
            clip-path: polygon(0 0, 100% 0, 100% 97%, 67% 100%, 33% 98%, 0 100%);
        }
        .highlight-nav {
		    background-color: white;
		    color: #7e57c2 !important;
		    border-radius: 20px;
		    padding: 6px 14px;
		    font-weight: 600;
		    display: inline-block;
   			width: auto;
		}
		
		.highlight-nav:hover {
		    background-color: #f2eaff;
		}
        .c-link.active {
            color: white;
        }
        .modal-header.primary-color {
            background-color: #7e57c2 !important;
        }
        .img-profile {
            border-radius: 50%;
            max-width: 150px;
        }
        body{
            background: url(image/blog.jpg);
            background-size: cover;
            background-attachment: fixed; 
        }
    </style>
</head>
<body>
	<!-- Profile Page Navbar -->
	<nav class="navbar navbar-expand-lg navbar-dark primary-color">
	    <div class="container-fluid">
	        <!-- Brand -->
	        <a class="navbar-brand" th:href="@{/}">
	            <span class="fa fa-wpforms"></span> Tech Blogging
	        </a>
	
	        <!-- Toggler -->
	        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
	                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
	                aria-expanded="false" aria-label="Toggle navigation">
	            <span class="navbar-toggler-icon"></span>
	        </button>
	
	        <!-- Navbar content -->
	        <div class="collapse navbar-collapse" id="navbarSupportedContent">
	            <!-- Left items -->
	            <ul class="navbar-nav d-flex flex-column flex-lg-row gap-2 me-auto mb-2 mb-lg-0">
	
	                <li class="nav-item">
	                    <a class="nav-link active" th:href="@{/profilePage}">
	                        <span class="fa fa-paste"></span> Blog Page
	                    </a>
	                </li>
	
	                <li class="nav-item dropdown">
	                    <a class="nav-link active dropdown-toggle" href="#" id="navbarDropdown"
	                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
	                        <span class="fa fa-navicon"></span> Categories
	                    </a>
	                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
					        <li th:each="c, iterStat : ${categories}">
					            <a class="dropdown-item c-link-1"
					               th:text="${c.name}"
					               href="#"
					               th:onclick="|getPosts1(${c.id}, ${iterStat.index})|">
					            </a>
					        </li>
					    </ul>
	                </li>
	
	                <li class="nav-item">
	                    <a class="nav-link active" href="#">
	                        <span class="fa fa-address-book-o"></span> Contact Us
	                    </a>
	                </li>
	
	                <li class="nav-item">
	                    <a class="nav-link active highlight-nav" href="#" data-bs-toggle="modal" data-bs-target="#addModal">
	                        <span class="fa fa-paper-plane-o"></span> Add Posts
	                    </a>
	                </li>
	
	                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
	                    <a class="nav-link active highlight-nav" href="#" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
	                        <span class="fa fa-cogs"></span> Add Categories
	                    </a>
	                </li>
	            </ul>
	
	            <!-- Right items -->
	            <ul class="navbar-nav ms-auto">
	                <li class="nav-item">
	                    <a class="nav-link active" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
	                        <span class="fa fa-user-circle"></span>
	                        <span th:text="${currentUser.name}"></span>
	                    </a>
	                </li>
	                <li class="nav-item">
					    <a class="nav-link active" href="#" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
					        <span class="fa fa-sign-out"></span> Logout
					    </a>
					</li>
					

	            </ul>
	        </div>
	    </div>
	</nav>
	
	<form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
	</form>
	
	<!-- Alert message -->
	<div th:if="${successMsg}" class="alert alert-success" th:text="${successMsg}"></div>
	<div th:if="${errorMsg}" class="alert alert-danger" th:text="${errorMsg}"></div>
	
	<!-- Main content -->
	<main>
	    <div class="container mt-4">
	        <div class="row">
	            <!-- Sidebar -->
	            <div class="col-md-3">
	                <div class="list-group">
	                    <a href="#" onclick="getPosts(0, 0)" class="c-link list-group-item list-group-item-action active">
	                        All Posts
	                    </a>
	                    <!-- Add more categories dynamically here -->
	                    <a href="#"
					       th:each="c, iterStat : ${categories}"
					       class="c-link list-group-item list-group-item-action"
					       th:text="${c.name}"
					       th:onclick="|getPosts(${c.id}, ${iterStat.index + 1})|">
					    </a>
	                </div>
	            </div>
	
	            <!-- Posts Area -->
	            <div class="col-md-9">
	                <div class="container text-center" id="loader">
	                    <i class="fa fa-refresh fa-4x fa-spin"></i>
	                    <h3 class="mt-3">Loading...</h3>
	                </div>
	
	                <div class="container-fluid" id="post-container">
	                    <!-- Posts dynamically injected here -->
	                </div>
	            </div>
	        </div>
	    </div>
	</main>
	
	
	
	<!-- âœ… Modals -->
	<div th:replace="~{fragments/profileModal :: profileModal}"></div>
	<div th:replace="~{fragments/addPostModal :: addPostModal}"></div>
	<div th:replace="~{fragments/addCategoryModal :: addCategoryModal}"></div>
	<div th:replace="~{fragments/updatePostModal :: updatePostModal}"></div>
	
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
	
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
	<script>
				
		async function getPosts(catId, index) {
		    const loader = document.getElementById("loader");
		    const postContainer = document.getElementById("post-container");
		
		    // Show loader
		    loader.style.display = "block";
		    postContainer.style.display = "none";
		
		    // Remove 'active' from all category links
		    document.querySelectorAll(".c-link, .c-link-1").forEach(el => el.classList.remove("active"));
		
		    try {
		        // Fetch posts fragment
		        const response = await fetch(`/loadPosts?id=${catId}`);
		        if (!response.ok) throw new Error("Network response was not ok");
		
		        const html = await response.text();
		        postContainer.innerHTML = html;
		
		        // Hide loader, show posts
		        loader.style.display = "none";
		        postContainer.style.display = "block";
		
		        // Add active class to selected link
		        const links = document.querySelectorAll(".c-link");
		        if (links[index]) links[index].classList.add("active");
		        
		        const navbarLinks = document.querySelectorAll(".c-link-1");
		        if (navbarLinks[index-1]) {
		            navbarLinks[index-1].classList.add("active");
		        }
		
		    } catch (error) {
		        loader.style.display = "none";
		        postContainer.style.display = "block";
		        postContainer.innerHTML = `
		            <div class="alert alert-danger text-center">
		                Failed to load posts. Please try again.
		            </div>`;
		        console.error("Error fetching posts:", error);
		    }
		}
		document.addEventListener("DOMContentLoaded", () => {
		    getPosts(0, 0);
		});
		
		async function getPosts1(catId, index) {
		    const loader = document.getElementById("loader");
		    const postContainer = document.getElementById("post-container");

		    // Show loader, hide post container
		    loader.style.display = "block";
		    postContainer.style.display = "none";

		    // Remove 'active' class from all category links (both sidebar and navbar)
		    document.querySelectorAll(".c-link, .c-link-1").forEach(el => el.classList.remove("active"));

		    try {
		        // Fetch posts fragment from Spring controller
		        const response = await fetch(`/loadPosts?id=${catId}`);
		        if (!response.ok) throw new Error("Failed to load posts");

		        const html = await response.text();

		        // Update post container
		        postContainer.innerHTML = html;
		        loader.style.display = "none";
		        postContainer.style.display = "block";

		        // Highlight the selected navbar link
		        const navbarLinks = document.querySelectorAll(".c-link-1");
		        if (navbarLinks[index]) {
		            navbarLinks[index].classList.add("active");
		        }

		        // Highlight the corresponding sidebar category
		        const sidebarLinks = document.querySelectorAll(".c-link");
		        if (sidebarLinks[index + 1]) {
		            sidebarLinks[index + 1].classList.add("active");
		        }

		    } catch (error) {
		        loader.style.display = "none";
		        postContainer.style.display = "block";
		        postContainer.innerHTML = `
		            <div class="alert alert-danger text-center">
		                Failed to load posts. Please try again later.
		            </div>`;
		        console.error("Error in getPosts1:", error);
		    }
		}
	</script>
	
	<script>
	
				
		document.addEventListener("submit", async function (event) {
		    const form = event.target.closest("#add-post-form");
		    if (!form) return;
		    event.preventDefault();
		
		    console.log("Submitting post...");
		    const formData = new FormData(form);
		
		    try {
		        const response = await fetch("/addPost", {
		            method: "POST",
		            body: formData
		        });
		
		        const data = await response.text();
		        console.log("Response:", data);
		
		        if (data.trim() === "done") {
	        	  Swal.fire({
	        	    icon: "success",
	        	    title: "Good Job!",
	        	    text: "Saved successfully.",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	} else if (data.trim() === "Unauthorized") {
	        	  Swal.fire({
	        	    icon: "warning",
	        	    title: "Unauthorized",
	        	    text: "Please login first.",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	} else if (data.trim() === "file-error") {
	        	  Swal.fire({
	        	    icon: "error",
	        	    title: "Error",
	        	    text: "Failed to save image file.",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	} else {
	        	  Swal.fire({
	        	    icon: "error",
	        	    title: "Error",
	        	    text: "Something went wrong! Try again...",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	}

		
		    } catch (error) {
		        console.error("Error:", error);
		        Swal.fire({
	        	    icon: "error",
	        	    title: "Error",
	        	    text: "Something went wrong! Try again...",
	        	    timer: 1500
	        	});
		        window.location.reload();
		    }
		});
	
	</script>
	
	<script>
	
				
		document.addEventListener("submit", async function (event) {
		    const form = event.target.closest("#add-categry-form");
		    if (!form) return;
		    event.preventDefault();
		
		    console.log("Saving category...");
		    const formData = new FormData(form);
		
		    try {
		        const response = await fetch("/addCategory", {
		            method: "POST",
		            body: formData
		        });
		
		        const data = await response.text();
		        console.log("Response:", data);
		
		        if (data.trim() === "done") {
	        	  Swal.fire({
	        	    icon: "success",
	        	    title: "Good Job!",
	        	    text: "Category saved successfully.",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	} else if (data.trim() === "Unauthorized") {
	        	  Swal.fire({
	        	    icon: "warning",
	        	    title: "Unauthorized",
	        	    text: "Please login first.",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	} else if (data.trim() === "file-error") {
	        	  Swal.fire({
	        	    icon: "error",
	        	    title: "Error",
	        	    text: "Failed to save image file.",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	} else {
	        	  Swal.fire({
	        	    icon: "error",
	        	    title: "Error",
	        	    text: "Something went wrong! Try again...",
	        	    timer: 1500
	        	  });
	        	  window.location.reload();
	        	}

		
		    } catch (error) {
		        console.error("Error:", error);
		        Swal.fire({
	        	    icon: "error",
	        	    title: "Error",
	        	    text: "Something went wrong! Try again...",
	        	    timer: 1500
	        	});
		        window.location.reload();
		    }
		});
	
	</script>

	<script>
		document.addEventListener("click", function (event) {
		    const editBtn = event.target.closest("#edit-profile-button");
		    if (!editBtn) return;
		
		    const profileDetails = document.getElementById("profile-details");
		    const profileEdit = document.getElementById("profile-edit");
		
		    if (profileDetails && profileEdit) {
		        const isEditing = profileEdit.style.display === "block";
		
		        if (isEditing) {
		            profileDetails.style.display = "block";
		            profileEdit.style.display = "none";
		            editBtn.textContent = "EDIT";
		        } else {
		            profileDetails.style.display = "none";
		            profileEdit.style.display = "block";
		            editBtn.textContent = "Back";
		        }
		    }
		});
	</script>
	
	<script th:inline="javascript">
	  const appContextPath = /*[[@{/}]]*/ '';  // "" or "/Techblogging"
	
	  async function openEditModal(id) {
	    try {
	      const resp = await fetch(`${appContextPath}post/${id}`);
	      if (!resp.ok) throw new Error('Failed to fetch post');
	      const data = await resp.json();
	
	      // populate fields
	      document.getElementById('edit-post-id').value    = data.id ?? '';
	      document.getElementById('edit-post-title').value = data.title ?? '';
	      document.getElementById('edit-post-content').value = data.content ?? '';
	      document.getElementById('edit-post-code').value = data.code ?? '';
	
	      // category select etc...
	
	      // image preview
	      const preview = document.getElementById('edit-post-preview');
	      if (preview) {
	        if (data.pic) {
	          preview.src = appContextPath + 'blog_pics/' + encodeURIComponent(data.pic);
	          preview.style.display = 'block';
	        } else {
	          preview.style.display = 'none';
	        }
	      }
	
	      const editModalEl = document.getElementById('updatePostModal');
	      const modal = bootstrap.Modal.getOrCreateInstance(editModalEl);
	      modal.show();
	
	    } catch (err) {
	      console.error('openEditModal error:', err);
	      alert('Could not load post for editing.');
	    }
	  }
	</script>

	<script>
		async function deletePost(id) {
		
		    const result = await Swal.fire({
		        title: "Are you sure?",
		        text: "This post will be permanently deleted!",
		        icon: "warning",
		        showCancelButton: true,
		        confirmButtonColor: "#d33",
		        cancelButtonColor: "#3085d6",
		        confirmButtonText: "Yes, delete it!"
		    });
		
		    if (!result.isConfirmed) return;
		
		    try {
		        const resp = await fetch(`/deletePost/${id}`, {
		            method: "DELETE"
		        });
		
		        const msg = await resp.text();
		
		        if (resp.ok && msg.includes("Deleted")) {
		            await Swal.fire({
		                icon: "success",
		                title: "Deleted!",
		                text: msg,
		                timer: 1500,
		                showConfirmButton: false
		            });
		            window.location.reload();
		        } else {
		            Swal.fire({
		                icon: "error",
		                title: "Action Denied",
		                text: msg
		            });
		            window.location.reload();
		        }
		
		    } catch (err) {
		        console.error("Delete error:", err);
		        Swal.fire({
		            icon: "error",
		            title: "Network Error",
		            text: "Could not delete post. Please try again."
		        });
		        window.location.reload();
		    }
		}
	</script>

			
</body>
</html>